<!DOCTYPE html>
<html lang="en-us">

<head>
  

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>

<link rel="shortcut icon" type="image/png" href="/favicon.ico"/>


<link rel='stylesheet' href='/style.min.0122b8d14d9247c2ac34fa87ad975f23eb927ad958d8ae6bda2caccd9ac9eb42.css'>


<script src='/main.min.db37c27117ff8400e5e30549f6806d2bc825668b596d81316c6148417f59bc72.js' async></script>


  <title>Configuring full-text search - Mastodon documentation</title>

  <meta property="og:type" content="article">
  <meta property="og:url" content="https://docs.joinmastodon.org/admin/elasticsearch/">

  
    <meta name="description" content="Setting up Elasticsearch to search for statuses (authored, favourited, or mentioned), public indexable status, and accounts">
    <meta property="og:description" content="Setting up Elasticsearch to search for statuses (authored, favourited, or mentioned), public indexable status, and accounts">
    <meta name="twitter:description" content="Setting up Elasticsearch to search for statuses (authored, favourited, or mentioned), public indexable status, and accounts">
  

  <meta name="twitter:title" content="Configuring full-text search">
  <meta name="twitter:site" content="@joinmastodon">

  <link rel="canonical" href="https://docs.joinmastodon.org/admin/elasticsearch/">
</head>

<body>
  <div class="container sidebar-layout">
    <nav class="sidebar"><a class="brand" href="/">
  <img class="link-logo" src="/brand.svg" alt="Mastodon" />
</a>

<input id="mobile-nav-toggle" class="mobile-nav-toggle" type="checkbox">
<label for="mobile-nav-toggle">
    <span class="menu-open">
        <i class="fa fa-times"></i> Close
    </span>
    <span class="menu-close">
        <i class="fa fa-bars"></i> Menu
    </span>
</label>

<ul>
  
  
    <li>
      
        <a href="/" class="">What is Mastodon?</a>
      

      
    </li>
  
    <li>
      
        <span class="sub-title">Using Mastodon</span>
      

      
        <ul class="sub-menu">
          
            <li>
              <a href="/user/signup/" class="">Signing up for an account</a>

              
            </li>
          
            <li>
              <a href="/user/profile/" class="">Setting up your profile</a>

              
            </li>
          
            <li>
              <a href="/user/posting/" class="">Posting to your profile</a>

              
            </li>
          
            <li>
              <a href="/user/network/" class="">Using the network features</a>

              
            </li>
          
            <li>
              <a href="/user/moderating/" class="">Dealing with unwanted content</a>

              
            </li>
          
            <li>
              <a href="/user/discoverability/" class="">Promoting yourself and others</a>

              
            </li>
          
            <li>
              <a href="/user/preferences/" class="">Set your preferences</a>

              
            </li>
          
            <li>
              <a href="/user/contacts/" class="">More settings</a>

              
            </li>
          
            <li>
              <a href="/user/external/" class="">Using Mastodon externally</a>

              
            </li>
          
            <li>
              <a href="/user/moving/" class="">Moving or leaving accounts</a>

              
            </li>
          
            <li>
              <a href="/user/run-your-own/" class="">Running your own server</a>

              
            </li>
          
        </ul>
      
    </li>
  
    <li>
      
        <span class="sub-title">Running Mastodon</span>
      

      
        <ul class="sub-menu">
          
            <li>
              <a href="/admin/prerequisites/" class="">Preparing your machine</a>

              
            </li>
          
            <li>
              <a href="/admin/install/" class="">Installing from source</a>

              
            </li>
          
            <li>
              <a href="/admin/config/" class="">Configuring your environment</a>

              
            </li>
          
            <li>
              <a href="/admin/elasticsearch/" class="active">Configuring full-text search</a>

              
            </li>
          
            <li>
              <a href="/admin/optional/" class="">Installing optional features</a>

              
                <ul class="sub-menu">
                  
                    <li>
                      <a href="/admin/optional/object-storage/" class="">Object storage</a>
                    </li>
                  
                    <li>
                      <a href="/admin/optional/tor/" class="">Onion services</a>
                    </li>
                  
                    <li>
                      <a href="/admin/optional/captcha/" class="">Captcha</a>
                    </li>
                  
                    <li>
                      <a href="/admin/optional/sso/" class="">Single Sign On</a>
                    </li>
                  
                </ul>
              
            </li>
          
            <li>
              <a href="/admin/setup/" class="">Setting up your new instance</a>

              
            </li>
          
            <li>
              <a href="/admin/tootctl/" class="">Using the admin CLI</a>

              
            </li>
          
            <li>
              <a href="/admin/upgrading/" class="">Upgrading to a new release</a>

              
            </li>
          
            <li>
              <a href="/admin/backups/" class="">Backing up your server</a>

              
            </li>
          
            <li>
              <a href="/admin/migrating/" class="">Migrating to a new machine</a>

              
            </li>
          
            <li>
              <a href="/admin/scaling/" class="">Scaling up your server</a>

              
            </li>
          
            <li>
              <a href="/admin/moderation/" class="">Moderation actions</a>

              
            </li>
          
            <li>
              <a href="/admin/troubleshooting/" class="">Troubleshooting errors</a>

              
                <ul class="sub-menu">
                  
                    <li>
                      <a href="/admin/troubleshooting/index-corruption/" class="">Database index corruption</a>
                    </li>
                  
                </ul>
              
            </li>
          
            <li>
              <a href="/admin/roles/" class="">Roles</a>

              
            </li>
          
        </ul>
      
    </li>
  
    <li>
      
        <span class="sub-title">Developing Mastodon apps</span>
      

      
        <ul class="sub-menu">
          
            <li>
              <a href="/client/intro/" class="">Getting started with the API</a>

              
            </li>
          
            <li>
              <a href="/client/public/" class="">Playing with public data</a>

              
            </li>
          
            <li>
              <a href="/client/token/" class="">Obtaining client app access</a>

              
            </li>
          
            <li>
              <a href="/client/authorized/" class="">Logging in with an account</a>

              
            </li>
          
            <li>
              <a href="/client/libraries/" class="">Libraries and implementations</a>

              
            </li>
          
        </ul>
      
    </li>
  
    <li>
      
        <span class="sub-title">Contributing to Mastodon</span>
      

      
        <ul class="sub-menu">
          
            <li>
              <a href="/dev/overview/" class="">Technical overview</a>

              
            </li>
          
            <li>
              <a href="/dev/setup/" class="">Setting up a dev environment</a>

              
            </li>
          
            <li>
              <a href="/dev/code/" class="">Code structure</a>

              
            </li>
          
            <li>
              <a href="/dev/routes/" class="">Routes</a>

              
            </li>
          
            <li>
              <a href="/dev/disclosure/" class="">Bug bounties and responsible disclosure</a>

              
            </li>
          
        </ul>
      
    </li>
  
    <li>
      
        <span class="sub-title">Spec compliance</span>
      

      
        <ul class="sub-menu">
          
            <li>
              <a href="/spec/activitypub/" class="">ActivityPub</a>

              
            </li>
          
            <li>
              <a href="/spec/webfinger/" class="">WebFinger</a>

              
            </li>
          
            <li>
              <a href="/spec/security/" class="">Security</a>

              
            </li>
          
            <li>
              <a href="/spec/microformats/" class="">Microformats</a>

              
            </li>
          
            <li>
              <a href="/spec/oauth/" class="">OAuth</a>

              
            </li>
          
            <li>
              <a href="/spec/bearcaps/" class="">Bearcaps</a>

              
            </li>
          
        </ul>
      
    </li>
  
    <li>
      
        <span class="sub-title">REST API</span>
      

      
        <ul class="sub-menu">
          
            <li>
              <a href="/api/guidelines/" class="">Guidelines and best practices</a>

              
            </li>
          
            <li>
              <a href="/api/oauth-scopes/" class="">OAuth Scopes</a>

              
            </li>
          
            <li>
              <a href="/api/rate-limits/" class="">Rate limits</a>

              
            </li>
          
        </ul>
      
    </li>
  
    <li>
      
        <span class="sub-title">API Methods</span>
      

      
        <ul class="sub-menu">
          
            <li>
              <a href="/methods/apps/" class="">apps</a>

              
                <ul class="sub-menu">
                  
                    <li>
                      <a href="/methods/oauth/" class="">oauth</a>
                    </li>
                  
                    <li>
                      <a href="/methods/emails/" class="">emails</a>
                    </li>
                  
                </ul>
              
            </li>
          
            <li>
              <a href="/methods/accounts/" class="">accounts</a>

              
                <ul class="sub-menu">
                  
                    <li>
                      <a href="/methods/bookmarks/" class="">bookmarks</a>
                    </li>
                  
                    <li>
                      <a href="/methods/favourites/" class="">favourites</a>
                    </li>
                  
                    <li>
                      <a href="/methods/mutes/" class="">mutes</a>
                    </li>
                  
                    <li>
                      <a href="/methods/blocks/" class="">blocks</a>
                    </li>
                  
                    <li>
                      <a href="/methods/domain_blocks/" class="">domain_blocks</a>
                    </li>
                  
                    <li>
                      <a href="/methods/filters/" class="">filters</a>
                    </li>
                  
                    <li>
                      <a href="/methods/reports/" class="">reports</a>
                    </li>
                  
                    <li>
                      <a href="/methods/follow_requests/" class="">follow_requests</a>
                    </li>
                  
                    <li>
                      <a href="/methods/endorsements/" class="">endorsements</a>
                    </li>
                  
                    <li>
                      <a href="/methods/featured_tags/" class="">featured_tags</a>
                    </li>
                  
                    <li>
                      <a href="/methods/preferences/" class="">preferences</a>
                    </li>
                  
                    <li>
                      <a href="/methods/followed_tags/" class="">followed_tags</a>
                    </li>
                  
                    <li>
                      <a href="/methods/suggestions/" class="">suggestions</a>
                    </li>
                  
                    <li>
                      <a href="/methods/tags/" class="">tags</a>
                    </li>
                  
                </ul>
              
            </li>
          
            <li>
              <a href="/methods/profile/" class="">profile</a>

              
            </li>
          
            <li>
              <a href="/methods/statuses/" class="">statuses</a>

              
                <ul class="sub-menu">
                  
                    <li>
                      <a href="/methods/media/" class="">media</a>
                    </li>
                  
                    <li>
                      <a href="/methods/polls/" class="">polls</a>
                    </li>
                  
                    <li>
                      <a href="/methods/scheduled_statuses/" class="">scheduled_statuses</a>
                    </li>
                  
                </ul>
              
            </li>
          
            <li>
              <a href="/methods/timelines/" class="">timelines</a>

              
                <ul class="sub-menu">
                  
                    <li>
                      <a href="/methods/conversations/" class="">conversations</a>
                    </li>
                  
                    <li>
                      <a href="/methods/lists/" class="">lists</a>
                    </li>
                  
                    <li>
                      <a href="/methods/markers/" class="">markers</a>
                    </li>
                  
                    <li>
                      <a href="/methods/streaming/" class="">streaming</a>
                    </li>
                  
                </ul>
              
            </li>
          
            <li>
              <a href="/methods/notifications/" class="">notifications</a>

              
                <ul class="sub-menu">
                  
                    <li>
                      <a href="/methods/push/" class="">push</a>
                    </li>
                  
                </ul>
              
            </li>
          
            <li>
              <a href="/methods/search/" class="">search</a>

              
            </li>
          
            <li>
              <a href="/methods/instance/" class="">instance</a>

              
                <ul class="sub-menu">
                  
                    <li>
                      <a href="/methods/trends/" class="">trends</a>
                    </li>
                  
                    <li>
                      <a href="/methods/directory/" class="">directory</a>
                    </li>
                  
                    <li>
                      <a href="/methods/custom_emojis/" class="">custom_emojis</a>
                    </li>
                  
                    <li>
                      <a href="/methods/announcements/" class="">announcements</a>
                    </li>
                  
                </ul>
              
            </li>
          
            <li>
              <a href="/methods/admin/" class="">admin</a>

              
                <ul class="sub-menu">
                  
                    <li>
                      <a href="/methods/admin/accounts/" class="">accounts</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/canonical_email_blocks/" class="">canonical_email_blocks</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/dimensions/" class="">dimensions</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/domain_allows/" class="">domain_allows</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/domain_blocks/" class="">domain_blocks</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/email_domain_blocks/" class="">email_domain_blocks</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/ip_blocks/" class="">ip_blocks</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/measures/" class="">measures</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/reports/" class="">reports</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/retention/" class="">retention</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/trends/" class="">trends</a>
                    </li>
                  
                </ul>
              
            </li>
          
            <li>
              <a href="/methods/proofs/" class="">proofs</a>

              
            </li>
          
            <li>
              <a href="/methods/oembed/" class="">oembed</a>

              
            </li>
          
        </ul>
      
    </li>
  
    <li>
      
        <span class="sub-title">API Entities</span>
      

      
        <ul class="sub-menu">
          
            <li>
              <a href="/entities/Account/" class="">Account</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_Account/" class="">Admin::Account</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_CanonicalEmailBlock/" class="">Admin::CanonicalEmailBlock</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_Cohort/" class="">Admin::Cohort</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_Dimension/" class="">Admin::Dimension</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_DomainAllow/" class="">Admin::DomainAllow</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_DomainBlock/" class="">Admin::DomainBlock</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_EmailDomainBlock/" class="">Admin::EmailDomainBlock</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_Ip/" class="">Admin::Ip</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_IpBlock/" class="">Admin::IpBlock</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_Measure/" class="">Admin::Measure</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_Report/" class="">Admin::Report</a>

              
            </li>
          
            <li>
              <a href="/entities/Announcement/" class="">Announcement</a>

              
            </li>
          
            <li>
              <a href="/entities/Application/" class="">Application</a>

              
            </li>
          
            <li>
              <a href="/entities/Context/" class="">Context</a>

              
            </li>
          
            <li>
              <a href="/entities/Conversation/" class="">Conversation</a>

              
            </li>
          
            <li>
              <a href="/entities/CustomEmoji/" class="">CustomEmoji</a>

              
            </li>
          
            <li>
              <a href="/entities/DomainBlock/" class="">DomainBlock</a>

              
            </li>
          
            <li>
              <a href="/entities/Error/" class="">Error</a>

              
            </li>
          
            <li>
              <a href="/entities/ExtendedDescription/" class="">ExtendedDescription</a>

              
            </li>
          
            <li>
              <a href="/entities/FamiliarFollowers/" class="">FamiliarFollowers</a>

              
            </li>
          
            <li>
              <a href="/entities/FeaturedTag/" class="">FeaturedTag</a>

              
            </li>
          
            <li>
              <a href="/entities/Filter/" class="">Filter</a>

              
            </li>
          
            <li>
              <a href="/entities/FilterKeyword/" class="">FilterKeyword</a>

              
            </li>
          
            <li>
              <a href="/entities/FilterResult/" class="">FilterResult</a>

              
            </li>
          
            <li>
              <a href="/entities/FilterStatus/" class="">FilterStatus</a>

              
            </li>
          
            <li>
              <a href="/entities/IdentityProof/" class="">IdentityProof</a>

              
            </li>
          
            <li>
              <a href="/entities/Instance/" class="">Instance</a>

              
            </li>
          
            <li>
              <a href="/entities/List/" class="">List</a>

              
            </li>
          
            <li>
              <a href="/entities/Marker/" class="">Marker</a>

              
            </li>
          
            <li>
              <a href="/entities/MediaAttachment/" class="">MediaAttachment</a>

              
            </li>
          
            <li>
              <a href="/entities/Notification/" class="">Notification</a>

              
            </li>
          
            <li>
              <a href="/entities/Poll/" class="">Poll</a>

              
            </li>
          
            <li>
              <a href="/entities/Preferences/" class="">Preferences</a>

              
            </li>
          
            <li>
              <a href="/entities/PreviewCard/" class="">PreviewCard</a>

              
            </li>
          
            <li>
              <a href="/entities/Reaction/" class="">Reaction</a>

              
            </li>
          
            <li>
              <a href="/entities/Relationship/" class="">Relationship</a>

              
            </li>
          
            <li>
              <a href="/entities/RelationshipSeveranceEvent/" class="">RelationshipSeveranceEvent</a>

              
            </li>
          
            <li>
              <a href="/entities/Report/" class="">Report</a>

              
            </li>
          
            <li>
              <a href="/entities/Role/" class="">Role</a>

              
            </li>
          
            <li>
              <a href="/entities/Rule/" class="">Rule</a>

              
            </li>
          
            <li>
              <a href="/entities/ScheduledStatus/" class="">ScheduledStatus</a>

              
            </li>
          
            <li>
              <a href="/entities/Search/" class="">Search</a>

              
            </li>
          
            <li>
              <a href="/entities/Status/" class="">Status</a>

              
            </li>
          
            <li>
              <a href="/entities/StatusEdit/" class="">StatusEdit</a>

              
            </li>
          
            <li>
              <a href="/entities/StatusSource/" class="">StatusSource</a>

              
            </li>
          
            <li>
              <a href="/entities/Suggestion/" class="">Suggestion</a>

              
            </li>
          
            <li>
              <a href="/entities/Tag/" class="">Tag</a>

              
            </li>
          
            <li>
              <a href="/entities/Token/" class="">Token</a>

              
            </li>
          
            <li>
              <a href="/entities/Translation/" class="">Translation</a>

              
            </li>
          
            <li>
              <a href="/entities/V1_Filter/" class="">V1::Filter</a>

              
            </li>
          
            <li>
              <a href="/entities/V1_Instance/" class="">V1::Instance</a>

              
            </li>
          
            <li>
              <a href="/entities/WebPushSubscription/" class="">WebPushSubscription</a>

              
            </li>
          
        </ul>
      
    </li>
  
</ul>
</nav>
    <main>
  <h1>Configuring full-text search</h1>  
  
    <p>Setting up Elasticsearch to search for statuses (authored, favourited, or mentioned), public indexable status, and accounts</p>
  
  <aside>
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#install">Installing Elasticsearch</a></li>
        <li><a href="#config">Configuring Mastodon</a>
          <ul>
            <li><a href="#choosing-the-correct-preset">Choosing the correct preset</a></li>
            <li><a href="#security">Security</a></li>
            <li><a href="#populate-the-indices">Populate the indices</a></li>
          </ul>
        </li>
        <li><a href="#search-optimization-for-other-languages">Search optimization for other languages</a>
          <ul>
            <li><a href="#chinese-search-optimization">Chinese search optimization</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </aside>
  <div class="e-content">
    <p>Mastodon supports full-text search when Elasticsearch is available. It is strongly recommended to configure this feature.</p>
<p>Mastodon’s full-text search allows logged-in users to find results from:</p>
<ul>
<li>public statuses from accounts that opted into appearing in search results</li>
<li>their own statuses</li>
<li>their mentions</li>
<li>their favourites</li>
<li>their bookmarks</li>
<li>accounts (display name, usernames and bios)</li>
</ul>
<p>It deliberately does not allow searching for arbitrary strings in the entire database.</p>
<h2 id="install">Installing Elasticsearch</h2>
<div class="hint hint-info">
  <div class="hint-icon"><i class="fa fa-info-circle"></i></div>

  Mastodon is tested with Elasticsearch version 7. It should support OpenSearch, as well as Elasticsearch versions 6 and 8, but those setups are not officially supported.
</div>

<p>Elasticsearch requires a Java runtime. If you don’t have Java already installed, do it now. Assuming you are logged in as <code>root</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">apt install openjdk-17-jre-headless
</code></pre></div><p>Add the official Elasticsearch repository to apt:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">wget -O /usr/share/keyrings/elasticsearch.asc https://artifacts.elastic.co/GPG-KEY-elasticsearch
<span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">&#34;deb [signed-by=/usr/share/keyrings/elasticsearch.asc] https://artifacts.elastic.co/packages/7.x/apt stable main&#34;</span> &gt; /etc/apt/sources.list.d/elastic-7.x.list
</code></pre></div><p>Now you can install Elasticsearch:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">apt update
apt install elasticsearch
</code></pre></div><div class="hint hint-warning">
  <div class="hint-icon"><i class="fa fa-exclamation-circle"></i></div>

  <strong>Security warning:</strong> By default, Elasticsearch is supposed to bind to localhost only, i.e. be inaccessible from the outside network. You can check which address Elasticsearch binds to by looking at <code>network.host</code> within <code>/etc/elasticsearch/elasticsearch.yml</code>. Consider that anyone who can access Elasticsearch can access and modify any data within it, as there is no authentication layer. So it’s really important that the access is secured. Having a firewall that only exposes the 22, 80 and 443 ports is advisable, as outlined in the <a href="../../prerequisites/#install-a-firewall-and-only-whitelist-ssh-http-and-https-ports">main installation instructions</a>. If you have a multi-host setup, you must know how to secure internal traffic.
</div>

<p>To start Elasticsearch:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">systemctl daemon-reload
systemctl <span style="color:#8be9fd;font-style:italic">enable</span> --now elasticsearch
</code></pre></div><h2 id="config">Configuring Mastodon</h2>
<p>Edit <code>.env.production</code> to add the following variables:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#8be9fd;font-style:italic">ES_ENABLED</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">true</span>
<span style="color:#8be9fd;font-style:italic">ES_HOST</span><span style="color:#ff79c6">=</span>localhost
<span style="color:#8be9fd;font-style:italic">ES_PORT</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">9200</span>
<span style="color:#8be9fd;font-style:italic">ES_PRESET</span><span style="color:#ff79c6">=</span> <span style="color:#6272a4"># single_node_cluster, small_cluster or large_cluster</span>
<span style="color:#6272a4"># ES_USER=</span>
<span style="color:#6272a4"># ES_PASS=</span>
</code></pre></div><p><em>Note</em>: If using TLS, prepend the hostname with <code>https://</code>. For example: <code>https://elastic.example.com</code>.</p>
<h3 id="choosing-the-correct-preset">Choosing the correct preset</h3>
<p>The value for <code>ES_PRESET</code> depends on the size of your Elasticsearch and will be used to set the number of shards and replicas for your indices to the best value for your setup:</p>
<ul>
<li><code>single_node_cluster</code> if you only have one node in your Elasticsearch cluster. Indices will be configured without any replica</li>
<li><code>small_cluster</code> if you have less than 6 nodes in your cluster. Indices will be configured with 1 replica</li>
<li><code>large_cluster</code> if you have 6 or more nodes in your cluster. Indices will be configured with more shards than with the <code>small_cluster</code> setting, to allow them to be distributed over more nodes</li>
</ul>
<p>If you have multiple Mastodon servers on the same machine, and you are planning to use the same Elasticsearch installation for all of them, make sure that all of them have unique <code>REDIS_NAMESPACE</code> in their configurations, to differentiate the indices. If you need to override the prefix of the Elasticsearch indices, you can set <code>ES_PREFIX</code> directly.</p>
<h3 id="security">Security</h3>
<p>By default, Elasticsearch does not handle any authentication and every request is made with full admin permission. We strongly advise you to configure Elasticsearch security features on your cluster.</p>
<p>To configure it, please refer <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/security-minimal-setup.html">to the official documentation</a>. It will guide you through:</p>
<ul>
<li>Enabling the security features (<code>xpack.security.enabled: true</code>)</li>
<li>Creating passwords for built-in users</li>
</ul>
<p>Once done, you can create a custom role for Mastodon to connect.</p>
<p>For example (please adapt this snippet to use your Elastic admin password):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">curl -X POST -u elastic:admin_password <span style="color:#f1fa8c">&#34;localhost:9200/_security/role/mastodon_full_access?pretty&#34;</span> -H <span style="color:#f1fa8c">&#39;Content-Type: application/json&#39;</span> -d<span style="color:#f1fa8c">&#39;
</span><span style="color:#f1fa8c">{
</span><span style="color:#f1fa8c">  &#34;cluster&#34;: [&#34;monitor&#34;],
</span><span style="color:#f1fa8c">  &#34;indices&#34;: [{
</span><span style="color:#f1fa8c">    &#34;names&#34;: [&#34;*&#34;],
</span><span style="color:#f1fa8c">    &#34;privileges&#34;: [&#34;read&#34;, &#34;monitor&#34;, &#34;write&#34;, &#34;manage&#34;]
</span><span style="color:#f1fa8c">  }]
</span><span style="color:#f1fa8c">}
</span><span style="color:#f1fa8c">&#39;</span>
</code></pre></div><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/security-api-put-role.html">Elasticsearch documentation for role creation</a></p>
<p>Once the role is created, you can create a user for the Mastodon server to use, and assign it the role.</p>
<p>For example (please adapt this snippet to use your Elastic admin password, and customize your new user <code>mastodon</code> user password):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">curl -X POST -u elastic:admin_password <span style="color:#f1fa8c">&#34;localhost:9200/_security/user/mastodon?pretty&#34;</span> -H <span style="color:#f1fa8c">&#39;Content-Type: application/json&#39;</span> -d<span style="color:#f1fa8c">&#39;
</span><span style="color:#f1fa8c">{
</span><span style="color:#f1fa8c">  &#34;password&#34; : &#34;l0ng-r4nd0m-p@ssw0rd&#34;,
</span><span style="color:#f1fa8c">  &#34;roles&#34; : [&#34;mastodon_full_access&#34;]
</span><span style="color:#f1fa8c">}
</span><span style="color:#f1fa8c">&#39;</span>
</code></pre></div><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/security-api-put-user.html">Elasticsearch documentation for user creation</a></p>
<p>Once this is done, you need to configure Mastodon to use the credentials for your newly created user.</p>
<p>In <code>.env.production</code>, adjust your configuration:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#8be9fd;font-style:italic">ES_USER</span><span style="color:#ff79c6">=</span>mastodon
<span style="color:#8be9fd;font-style:italic">ES_PASS</span><span style="color:#ff79c6">=</span>l0ng-r4nd0m-p@ssw0rd
</code></pre></div><p>You are all set, and your Elasticsearch server should be much more secure!</p>
<h3 id="populate-the-indices">Populate the indices</h3>
<p>After saving the new configuration, restart Mastodon processes for it to take effect:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">systemctl restart mastodon-sidekiq
systemctl reload mastodon-web
</code></pre></div><p>Now it&rsquo;s time to create the Elasticsearch indices and fill them with data:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">su - mastodon
<span style="color:#8be9fd;font-style:italic">cd</span> live
<span style="color:#8be9fd;font-style:italic">RAILS_ENV</span><span style="color:#ff79c6">=</span>production bin/tootctl search deploy
</code></pre></div><h2 id="search-optimization-for-other-languages">Search optimization for other languages</h2>
<h3 id="chinese-search-optimization">Chinese search optimization</h3>
<p>The standard analyzer is the default for Elasticsearch, but for some languages like Chinese it may not be the optimal choice. To enhance the search experience, consider installing a language-specific analyzer. Before creating indices in Elasticsearch, be sure to install the following extensions:</p>
<ul>
<li><a href="https://github.com/medcl/elasticsearch-analysis-ik">elasticsearch-analysis-ik</a></li>
<li><a href="https://github.com/medcl/elasticsearch-analysis-stconvert">elasticsearch-analysis-stconvert</a></li>
</ul>
<p>And then modify Mastodon&rsquo;s index definition as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="font-weight:bold">diff --git a/app/chewy/accounts_index.rb b/app/chewy/accounts_index.rb
</span><span style="font-weight:bold"></span><span style="color:#8b080b">--- a/app/chewy/accounts_index.rb
</span><span style="color:#8b080b"></span><span style="font-weight:bold">+++ b/app/chewy/accounts_index.rb
</span><span style="font-weight:bold"></span><span style="font-weight:bold">@@ -4,7 +4,7 @@ class AccountsIndex &lt; Chewy::Index
</span><span style="font-weight:bold"></span>   settings index: { refresh_interval: &#39;5m&#39; }, analysis: {
     analyzer: {
       content: {
<span style="color:#8b080b">-        tokenizer: &#39;whitespace&#39;,
</span><span style="color:#8b080b"></span><span style="font-weight:bold">+        tokenizer: &#39;ik_max_word&#39;,
</span><span style="font-weight:bold"></span>         filter: %w(lowercase asciifolding cjk_width),
       },

<span style="font-weight:bold">diff --git a/app/chewy/statuses_index.rb b/app/chewy/statuses_index.rb
</span><span style="font-weight:bold"></span><span style="color:#8b080b">--- a/app/chewy/statuses_index.rb
</span><span style="color:#8b080b"></span><span style="font-weight:bold">+++ b/app/chewy/statuses_index.rb
</span><span style="font-weight:bold"></span><span style="font-weight:bold">@@ -16,9 +16,17 @@ class StatusesIndex &lt; Chewy::Index
</span><span style="font-weight:bold"></span>         language: &#39;possessive_english&#39;,
       },
     },
<span style="font-weight:bold">+    char_filter: {
</span><span style="font-weight:bold">+      tsconvert: {
</span><span style="font-weight:bold">+        type: &#39;stconvert&#39;,
</span><span style="font-weight:bold">+        keep_both: false,
</span><span style="font-weight:bold">+        delimiter: &#39;#&#39;,
</span><span style="font-weight:bold">+        convert_type: &#39;t2s&#39;,
</span><span style="font-weight:bold">+      },
</span><span style="font-weight:bold">+    },
</span><span style="font-weight:bold"></span>     analyzer: {
       content: {
<span style="color:#8b080b">-        tokenizer: &#39;uax_url_email&#39;,
</span><span style="color:#8b080b"></span><span style="font-weight:bold">+        tokenizer: &#39;ik_max_word&#39;,
</span><span style="font-weight:bold"></span>         filter: %w(
           english_possessive_stemmer
           lowercase
<span style="font-weight:bold">@@ -27,6 +35,7 @@ class StatusesIndex &lt; Chewy::Index
</span><span style="font-weight:bold"></span>           english_stop
           english_stemmer
         ),
<span style="font-weight:bold">+        char_filter: %w(tsconvert),
</span><span style="font-weight:bold"></span>       },
     },
   }
<span style="font-weight:bold">diff --git a/app/chewy/tags_index.rb b/app/chewy/tags_index.rb
</span><span style="font-weight:bold"></span><span style="color:#8b080b">--- a/app/chewy/tags_index.rb
</span><span style="color:#8b080b"></span><span style="font-weight:bold">+++ b/app/chewy/tags_index.rb
</span><span style="font-weight:bold"></span><span style="font-weight:bold">@@ -2,10 +2,19 @@
</span><span style="font-weight:bold"></span>
 class TagsIndex &lt; Chewy::Index
   settings index: { refresh_interval: &#39;15m&#39; }, analysis: {
<span style="font-weight:bold">+    char_filter: {
</span><span style="font-weight:bold">+      tsconvert: {
</span><span style="font-weight:bold">+        type: &#39;stconvert&#39;,
</span><span style="font-weight:bold">+        keep_both: false,
</span><span style="font-weight:bold">+        delimiter: &#39;#&#39;,
</span><span style="font-weight:bold">+        convert_type: &#39;t2s&#39;,
</span><span style="font-weight:bold">+      },
</span><span style="font-weight:bold">+    },
</span><span style="font-weight:bold"></span>     analyzer: {
       content: {
<span style="color:#8b080b">-        tokenizer: &#39;keyword&#39;,
</span><span style="color:#8b080b"></span><span style="font-weight:bold">+        tokenizer: &#39;ik_max_word&#39;,
</span><span style="font-weight:bold"></span>         filter: %w(lowercase asciifolding cjk_width),
<span style="font-weight:bold">+        char_filter: %w(tsconvert),
</span><span style="font-weight:bold"></span>       },

       edge_ngram: {
</code></pre></div>
    






  
  
  
  
    
    
    
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
      
  
  
  
    
    
    
    
      
        
          
          
        
        
      
    
      
        
          
          
        
        
      
    
      
        
          
          
        
        
      
    
      
        
          
          
            
            
<div style="margin: 30px 0px">
  <a id="previousLink" href="javascript:void(0)" style="font-size: 12pt">
    <i class="fa fa-arrow-left"></i> Page
  </a>
  <div id="pageTurnSpacer" style="display:inline; margin: 0px 50px"></div>  
  <a id="nextLink" href="javascript:void(0)" style="font-size: 12pt">
    Page <i class="fa fa-arrow-right"></i>
  </a>
</div>
          
        
        
      
    
      
        
          
          
        
        
          
          
            
            
          
            
            
          
            
            
          
            
            
          
        
      
    
      
        
          
          
        
        
      
    
      
        
          
          
        
        
      
    
      
        
          
          
        
        
      
    
      
        
          
          
        
        
      
    
      
        
          
          
        
        
      
    
      
        
          
          
        
        
      
    
      
        
          
          
        
        
      
    
      
        
          
          
        
        
          
          
            
            
          
        
      
    
      
        
          
          
        
        
      
      
  
  
  
    
    
    
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
      
  
  
  
    
    
    
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
      
  
  
  
    
    
    
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
      
  
  
  
    
    
    
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
      
  
  
  
    
    
    
    
      
        
          
          
            
            
          
            
            
          
        
      
    
      
        
          
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
        
      
    
      
        
          
                  
        
      
    
      
        
          
          
            
            
          
            
            
          
            
            
          
        
      
    
      
        
          
          
            
            
          
            
            
          
            
            
          
            
            
          
        
      
    
      
        
          
          
            
            
          
        
      
    
      
        
          
                  
        
      
    
      
        
          
          
            
            
          
            
            
          
            
            
          
            
            
          
        
      
    
      
        
          
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
      
  
  
  
    
    
    
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
    
      
        
          
                  
        
      
      
  


<script>
 
 
 
 
 
 
 var theMenuTag = "nav";           
 var theMenuSideBar = "sidebar";   
 var theMenuSubMenu = "sub-menu";  
 var theMenuActivePage = "active"; 

 
 
 var previousLink = document.getElementById("previousLink");     
 var nextLink = document.getElementById("nextLink");             
 var pageTurnSpacer = document.getElementById("pageTurnSpacer"); 
 
 
 
 var whatIsActive = -1, prevHref, prevName, nextHref, nextName;

 
 var selectNavs = document.getElementsByTagName(theMenuTag); 
 var selectSidebar;                                          
 for (i = 0; i < selectNavs.length; i++) {                   
   if (selectNavs[i].className == theMenuSideBar) {          
     selectSidebar = selectNavs[i];                          
     break; 
   }
 }

 
 
 var selectSubMenus = selectSidebar.getElementsByClassName(theMenuSubMenu); 
 
 
 for (i = 0; i < selectSubMenus.length; i++) {                      
   let curNavSection = selectSubMenus[i].getElementsByTagName("a"); 
   
   for (j = 0; j < curNavSection.length; j++) {
     if (curNavSection[j].className == theMenuActivePage) { 
      if (j == 0) {                                
        prevHref = "remove";                        
        nextHref = curNavSection[j+1].href;         
        nextName = curNavSection[j+1].innerText;    
        whatIsActive = i; 
      } else if (j == curNavSection.length - 1) {  
        prevHref = curNavSection[j-1].href;         
        prevName = curNavSection[j-1].innerText;    
        nextHref = "remove";                        
        whatIsActive = i; 
      } else {                                     
        prevHref = curNavSection[j-1].href;         
        prevName = curNavSection[j-1].innerText;    
        nextHref = curNavSection[j+1].href;         
        nextName = curNavSection[j+1].innerText;    
        whatIsActive = i; 
      }
       
       break;
     }
   }
   
   if (whatIsActive != -1) { break; }
 }
 
 if (prevHref == "remove") { 
   previousLink.remove();                                             
   pageTurnSpacer.remove();                                           
   nextLink.href = nextHref;                                          
   nextLink.innerHTML = nextLink.innerHTML.replace("Page", nextName); 
 } else if (nextHref == "remove") { 
   previousLink.href = prevHref;                                              
   previousLink.innerHTML = previousLink.innerHTML.replace("Page", prevName); 
   nextLink.remove();                                                         
 } else { 
   previousLink.href = prevHref;                                              
   previousLink.innerHTML = previousLink.innerHTML.replace("Page", prevName); 
   nextLink.href = nextHref;                                                  
   nextLink.innerHTML = nextLink.innerHTML.replace("Page", nextName);         
 }                                                                            
 
</script>

    <p style="color: #687590;">
      Last updated December 7, 2023 · <a href='https://github.com/mastodon/documentation/tree/main/content/en/admin/elasticsearch.md' style="color: #687590;">Improve this page</a>

      
    </p>

  </div>
</main>
  </div>

  <footer class="footer container">
  <div class="sponsorship">
    <div class="container">
      <h2>
        Sponsored by
      </h2>

      <div class="logo-grid">
        <div>
          <a href="https://www.dotcom-monitor.com/es/">
            <img src="/assets/sponsors/dotcom-monitor-logo.png" alt="Dotcom-Monitor" />
          </a>

          <a href="https://www.loadview-testing.com/products/jmeter-load-testing/">
            <img src="/assets/sponsors/LoadView-logo.png" alt="LoadView" />
          </a>

          <a href="http://www.stevetures.com/">
            <img src="/assets/sponsors/stephen-tures.jpg" alt="Stephen Tures" />
          </a>

          <a href="https://swayable.com">
            <img src="/assets/sponsors/swayable.jpeg" alt="Swayable" />
          </a>

          <a href="https://www.sponsormotion.com/">
            <img src="/assets/sponsors/SponsorMotion.png" alt="SponsorMotion" />
          </a>
        </div>
      </div>
    </div>
  </div>

  <p class="legal legal--right">
    <a href='https://joinmastodon.org'>Join Mastodon</a> · <a href='https://blog.joinmastodon.org'>Blog</a> · <a href='https://mastodon.social/@Mastodon' target='_blank'><i class='fab fa-mastodon'></i></a>
  </p>

  <p class="legal"><a href='https://github.com/mastodon/documentation/tree/main/content/en/admin/elasticsearch.md'>View source</a> · <a href='https://creativecommons.org/licenses/by-sa/4.0/'>CC BY-SA 4.0</a> · <a href='https://joinmastodon.org/imprint'>Imprint</a></p>
</footer>

</body>

</html>
